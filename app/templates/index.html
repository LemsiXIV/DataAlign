{% extends 'base.html' %}

{% block title %}DataAlign - Home{% endblock %}

{% block content %}
    <!-- Loading Spinner Overlay -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-[9999] flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-8 flex flex-col items-center shadow-xl">
            <div role="status">
                <svg aria-hidden="true" class="w-12 h-12 text-gray-200 animate-spin dark:text-gray-600 fill-blue-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                    <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                </svg>
                <span class="sr-only">Loading...</span>
            </div>
            <p id="loadingText" class="mt-4 text-lg font-medium text-gray-700 dark:text-gray-300">Processing your files...</p>
        </div>
    </div>

    <!-- hero start section -->
    <section class="bg-white dark:bg-gray-900">
        <div class="grid max-w-screen-xl px-4 py-8 mx-auto lg:gap-8 xl:gap-0 lg:py-16 lg:grid-cols-12">
            <div class="mr-auto place-self-center lg:col-span-7">
                <h1
                    class="max-w-2xl mb-4 text-4xl font-extrabold leading-none tracking-tight md:text-5xl xl:text-6xl dark:text-white">
                    DataAlign tool for software companies</h1>
                <p class="max-w-2xl mb-6 text-gray-500 lg:mb-8 md:text-lg lg:text-xl dark:text-gray-400">From checkout
                    to global sales tax compliance, companies around the world use Flowbite to simplify their payment
                    stack.</p>
                {% if current_user.is_authenticated %}
                <a id="defaultModalButton" data-modal-target="defaultModal" data-modal-toggle="defaultModal" href="#"
                    class="inline-flex items-center justify-center px-5 py-3 mr-3 text-base font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-900">
                    Create a Project
                    <svg class="w-5 h-5 ml-2 -mr-1" fill="currentColor" viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                            d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                            clip-rule="evenodd"></path>
                    </svg>
                </a>
                {% else %}
                <button onclick="showLoginPrompt()" 
                    class="inline-flex items-center justify-center px-5 py-3 mr-3 text-base font-medium text-center text-white bg-blue-700 rounded-lg hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-900">
                    Create a Project
                    <svg class="w-5 h-5 ml-2 -mr-1" fill="currentColor" viewBox="0 0 20 20"
                        xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                            d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                {% endif %}
                <a href="#" data-modal-target="Fast_Test-modal" data-modal-toggle="Fast_Test-modal"
                    class="inline-flex items-center justify-center px-5 py-3 text-base font-medium text-center text-gray-900 border border-gray-300 rounded-lg hover:bg-gray-100 focus:ring-4 focus:ring-gray-100 dark:text-white dark:border-gray-700 dark:hover:bg-gray-700 dark:focus:ring-gray-800">
                    Fast Test
                </a>
            </div>
            <div class="hidden lg:mt-0 lg:col-span-5 lg:flex">
                <img src="{{ url_for('static', filename='1311212_312.jpg') }}" alt="DataAlign illustration">
            </div>
        </div>
    </section>
    <!-- hero end section -->
    <!-- pop-up content start -->
    <div id="Fast_Test-modal" tabindex="-1" aria-hidden="true"
        class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-md max-h-full">
            <!-- Modal content -->
            <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                <!-- Modal header -->
                <div
                    class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                        Fast Test
                    </h3>
                    <button type="button"
                        class="end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white"
                        data-modal-hide="Fast_Test-modal">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                        </svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                </div>
                <!-- Modal body -->
                <div class="p-4 md:p-5">
                    <!-- Affichage des erreurs générales -->
                    {% if project_error and show_fast_modal %}
                    <div class="mb-4 p-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-200 dark:bg-gray-800 dark:text-red-400 animate-pulse" role="alert">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <span class="font-medium">Erreur :</span> {{ project_error }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <form class="space-y-4" action="{{ url_for('fichiers.fast_upload') }}" method="POST" enctype="multipart/form-data">
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                                for="user_avatar">Upload file 1 :</label>
                            <input
                                class="block w-full text-sm text-gray-900 border {% if file1_error %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %} rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"
                                aria-describedby="file_fast_upload" id="file_fast_upload" name="file_fast_upload"
                                type="file">
                            <div class="mt-1 text-sm text-gray-500 dark:text-gray-300" id="user_avatar_help">Veuillez
                                choisir un fichier du format suivant : CSV,XLSX,JSON.</div>
                            {% if file1_error %}
                            <div class="mt-1 text-sm text-red-600 animate-pulse" role="alert">
                                <span class="font-medium">⚠️ {{ file1_error }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                                for="user_avatar">Upload file 2 :</label>
                            <input
                                class="block w-full text-sm text-gray-900 border {% if file2_error %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %} rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"
                                aria-describedby="file_fast_upload2" id="file_fast_upload2" name="file_fast_upload2"
                                type="file">
                            <div class="mt-1 text-sm text-gray-500 dark:text-gray-300" id="user_avatar_help">Veuillez
                                choisir un fichier du format suivant : CSV,XLSX,JSON.</div>
                            {% if file2_error %}
                            <div class="mt-1 text-sm text-red-600 animate-pulse" role="alert">
                                <span class="font-medium">⚠️ {{ file2_error }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- GPT-4 Enhancement Options -->
                        <div class="border-t pt-4 border-gray-200 dark:border-gray-600">
                            <div class="flex items-center mb-3">
                                <input id="enable_gpt" name="enable_gpt" type="checkbox" value="true" 
                                    class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label for="enable_gpt" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">
                                    🤖 Amélioration GPT-4 (Expérimental)
                                </label>
                            </div>
                            <div class="ml-6 space-y-2 text-xs text-gray-500 dark:text-gray-400">
                                <p>• Analyse intelligente de la structure des données</p>
                                <p>• Nettoyage automatique des formats incohérents</p>
                                <p>• Suggestions d'optimisation pour la comparaison</p>
                            </div>
                        </div>
                        
                        <button type="submit" id="compareButton"
                            class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                            <span id="compareButtonText">Compaire</span>
                        </button>

                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- pop-up content start -->

    <!-- add project section -->
    <section class="py-10 px-4">

        <!-- Main modal -->
        <div id="defaultModal" tabindex="-1" aria-hidden="true"
            class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-modal md:h-full">
            <div class="relative p-4 w-full max-w-2xl h-full md:h-auto">
                <!-- Modal content -->
                <div class="relative p-4 bg-white rounded-lg shadow dark:bg-gray-800 sm:p-5">
                    <!-- Modal header -->
                    <div
                        class="flex justify-between items-center pb-4 mb-4 rounded-t border-b sm:mb-5 dark:border-gray-600">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                            Add Project
                        </h3>
                        <button type="button"
                            class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center dark:hover:bg-gray-600 dark:hover:text-white"
                            data-modal-toggle="defaultModal">
                            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd"
                                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <span class="sr-only">Close modal</span>
                        </button>
                    </div>
                    <!-- Modal body -->
                    <form action="{{ url_for('fichiers.upload_file') }}" method="POST" enctype="multipart/form-data">

                        <div class="grid gap-4 mb-4">
                            <!-- Nom du projet -->
                            <div>
                                <label for="name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                    Nom du projet
                                </label>
                                <input type="text" name="name" id="name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg 
                   focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 
                   dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 
                   dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                                    placeholder="Nom du projet" >
                                {% if project_error %}
                                <div class="mt-1 text-sm text-red-600" role="alert">
                                    {{ project_error }}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Sélection projet existant + Date -->
                            <div class="grid gap-4 sm:grid-cols-2">
                                <div>
                                    <label for="existing_project"
                                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                        Ou sélectionner un projet existant :
                                    </label>
                                    <select id="existing_project" name="existing_project" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg 
                       focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 
                       dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 
                       dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                        <option value="">-- Aucun --</option>
                                        {% for projet in projets %}
                                        <option value="{{ projet.id }}">{{ projet.nom_projet }} ({{ projet.date_creation
                                            }})</option>
                                        {% endfor %}
                                    </select>
                                </div>


                            <!-- Upload 1 + Upload 2 -->
                            <div class="grid gap-4 sm:grid-cols-2">
                                <!-- File 1 -->
                                <div>
                                    <label for="file"
                                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                        Upload file 1
                                    </label>
                                    <input type="file" id="file" name="file" class="block w-full text-sm text-gray-900 border {% if file1_error %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %} rounded-lg cursor-pointer 
                       bg-gray-50 dark:text-gray-400 focus:outline-none 
                       dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400">
                                    <div class="mt-1 text-xs text-gray-500 dark:text-gray-300">
                                        Veuillez choisir un fichier du format suivant : CSV, XLSX, JSON.
                                    </div>
                                    {% if file1_error %}
                                    <div class="mt-1 text-sm text-red-600 animate-pulse" role="alert">
                                        <span class="font-medium">⚠️ {{ file1_error }}</span>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- File 2 -->
                                <div>
                                    <label for="file2"
                                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                        Upload file 2
                                    </label>
                                    <input type="file" id="file2" name="file2" class="block w-full text-sm text-gray-900 border {% if file2_error %}border-red-500 bg-red-50{% else %}border-gray-300{% endif %} rounded-lg cursor-pointer 
                       bg-gray-50 dark:text-gray-400 focus:outline-none 
                       dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400">
                                    <div class="mt-1 text-xs text-gray-500 dark:text-gray-300">
                                        Veuillez choisir un fichier du format suivant : CSV, XLSX, JSON.
                                    </div>
                                    {% if file2_error %}
                                    <div class="mt-1 text-sm text-red-600 animate-pulse" role="alert">
                                        <span class="font-medium">⚠️ {{ file2_error }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>


                        <button type="submit" id="addProjectButton"
                            class="text-white inline-flex items-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
                            <svg class="mr-1 -ml-1 w-6 h-6" fill="currentColor" viewBox="0 0 20 20"
                                xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd"
                                    d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            <span id="addProjectButtonText">Add new Project</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>
    <!-- add project section end -->

    <!-- compart section -->
    {% if columns and columns2 %}
    <form method="POST" action="{{ form_action }}"
        class="max-w-xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mt-10">
        <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4 text-center">
            🔎 Choisissez les clés pour comparer
        </h3>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                🗂️ Clé dans le fichier 1 :
            </label>
            <select name="key1" multiple
                class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                {% for col in columns %}
                <option value="{{ col }}">{{ col }}</option>
                {% endfor %}
            </select>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Vous pouvez sélectionner plusieurs colonnes avec
                Ctrl / Cmd + clic.</p>

        </div>

        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                🗃️ Clé dans le fichier 2 :
            </label>
            <select name="key2" multiple
                class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                {% for col in columns2 %}
                <option value="{{ col }}">{{ col }}</option>
                {% endfor %}
            </select>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Vous pouvez sélectionner plusieurs colonnes avec
                Ctrl / Cmd + clic.</p>

        </div>

        <button type="submit"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
            🧮 Comparer
        </button>
    </form>
    {% endif %}

    <!-- compart nd section -->

    <!-- table start section -->

    {% if is_large_files %}
    <!-- Large file notification -->
    <section class="py-4 px-4">
        <div class="max-w-screen-xl mx-auto">
            <div class="p-4 mb-4 text-sm text-blue-800 rounded-lg bg-blue-50 dark:bg-gray-800 dark:text-blue-400" role="alert">
                <span class="font-medium">📊 Large Files Detected!</span> 
                One or both of your files are large 
                {% if file1_info %}(File 1: {{ "{:,}".format(file1_info.total_rows) }} rows, {{ file1_info.total_columns }} columns){% endif %}
                {% if file2_info %}(File 2: {{ "{:,}".format(file2_info.total_rows) }} rows, {{ file2_info.total_columns }} columns){% endif %}.
                The system will use optimized processing to handle them efficiently. Only a preview is shown below, but the full comparison will process all data.
            </div>
        </div>
    </section>
    {% endif %}

    <section class="py-10 px-4">
        <div class="flex flex-col md:flex-row gap-4">

            {% if data %}
            <!-- First Table -->
            <div
                class="flex-1 flex flex-col overflow-hidden overflow-y-auto max-h-[700px] shadow-lg rounded-lg bg-white dark:bg-gray-800">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">
                        📄 Données du premier fichier
                    </h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        Voici un aperçu des données extraites automatiquement.
                    </p>
                </div>

                <div class="flex-1 overflow-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                {% for col in columns %}
                                <th scope="col" class="px-6 py-3">
                                    {{ col }}
                                </th>
                                {% endfor %}
                                <th scope="col" class="px-6 py-3">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                            <tr
                                class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                {% for col in columns %}
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                    {{ row[col] }}
                                </td>
                                {% endfor %}
                                <td class="flex items-center px-6 py-4">
                                    <a href="#"
                                        class="font-medium text-blue-600 dark:text-blue-500 hover:underline">Edit</a>
                                    <a href="#"
                                        class="font-medium text-red-600 dark:text-red-500 hover:underline ms-3">Remove</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            {% if data2 %}
            <!-- Second Table -->
            <div
                class="flex-1 flex flex-col overflow-hidden overflow-y-auto max-h-[700px] shadow-lg rounded-lg bg-white dark:bg-gray-800">
                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">
                        📄 Données du deuxième fichier
                    </h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                        Voici un aperçu des données extraites automatiquement.
                    </p>
                </div>

                <div class="flex-1 overflow-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                {% for col in columns2 %}
                                <th scope="col" class="px-6 py-3">
                                    {{ col }}
                                </th>
                                {% endfor %}
                                <th scope="col" class="px-6 py-3">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data2 %}
                            <tr
                                class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                {% for col in columns2 %}
                                <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">
                                    {{ row[col] }}
                                </td>
                                {% endfor %}
                                <td class="flex items-center px-6 py-4">
                                    <a href="#"
                                        class="font-medium text-blue-600 dark:text-blue-500 hover:underline">Edit</a>
                                    <a href="#"
                                        class="font-medium text-red-600 dark:text-red-500 hover:underline ms-3">Remove</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </section>


{% endblock %}

{% block modals %}
<!-- Login Prompt Modal -->
<div id="loginPromptModal" tabindex="-1" aria-hidden="true"
    class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <!-- Modal header -->
            <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    🔐 Authentication Required
                </h3>
                <button type="button" onclick="closeLoginPrompt()"
                    class="end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <!-- Modal body -->
            <div class="p-4 md:p-5 text-center">
                <svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                </svg>
                <h3 class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">
                    You need to be logged in to create projects and use advanced features.
                </h3>
                <p class="mb-5 text-sm text-gray-400 dark:text-gray-300">
                    Please sign in to your account or create a new one to get started.
                </p>
                <div class="flex justify-center space-x-3">
                    <a href="{{ url_for('auth.login') }}" 
                       class="text-white bg-blue-600 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center">
                        Sign In
                    </a>
                    <a href="{{ url_for('auth.signup') }}" 
                       class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">
                        Create Account
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Spinner functionality
    function showSpinner(message = 'Processing your files...') {
        const spinner = document.getElementById('loadingSpinner');
        const loadingText = document.getElementById('loadingText');
        
        if (spinner && loadingText) {
            loadingText.textContent = message;
            spinner.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }
    }

    function hideSpinner() {
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) {
            spinner.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        }
    }

    // Add event listeners for form submissions
    document.addEventListener('DOMContentLoaded', function() {
        
        // Use event delegation to handle form submissions since forms are in modals
        document.addEventListener('submit', function(e) {
            const form = e.target;
            const action = form.getAttribute('action');
            
            // Fast Test form (Compare button)
            if (action && (action.includes('fast_upload') || action.includes('fast_test'))) {
                const gptEnabled = document.getElementById('enable_gpt')?.checked;
                const message = gptEnabled ? 
                    'Processing with GPT-4 enhancement...' : 
                    'Processing your files...';
                showSpinner(message);
            }
            // Main project form (Add new Project button)
            else if (action && (action.includes('upload_file') || action.includes('upload'))) {
                showSpinner('Creating project and processing files...');
            }
            // Comparison form (🧮 Comparer button)
            else if (action && (action.includes('fast_compare') || action.includes('compare'))) {
                showSpinner('Comparing files and generating results...');
            }
        });
    });

    // Hide spinner if page loads with errors (fallback)
    window.addEventListener('load', function() {
        // Small delay to ensure everything is loaded
        setTimeout(function() {
            if (!document.querySelector('.animate-pulse')) { // No error messages
                hideSpinner();
            }
        }, 1000);
    });

    // Project selection logic
    const selectProjet = document.getElementById('existing_project');
    const nomProjetInput = document.getElementById('name');

    if (selectProjet && nomProjetInput) {
        selectProjet.addEventListener('change', () => {
            if (selectProjet.value !== '') {
                nomProjetInput.disabled = true;
                nomProjetInput.value = ''; // optionnel : vide le champ si un projet est sélectionné
            } else {
                nomProjetInput.disabled = false;
            }
        });
    }

    // Auto-open fast test modal if there are errors
    {% if show_fast_modal %}
    document.addEventListener('DOMContentLoaded', function() {
        // Ouvrir automatiquement le modal de test rapide avec le backdrop
        const modal = document.getElementById('Fast_Test-modal');
        if (modal) {
            // Supprimer la classe hidden et ajouter les classes pour afficher le modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.setAttribute('aria-hidden', 'false');
            modal.setAttribute('aria-modal', 'true');
            modal.setAttribute('role', 'dialog');
            
            // Ajouter les styles pour le backdrop
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '50';
            
            // Empêcher le scroll du body
            document.body.style.overflow = 'hidden';
            
            // Gérer la fermeture du modal
            const closeButton = modal.querySelector('[data-modal-hide="Fast_Test-modal"]');
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modal.setAttribute('aria-hidden', 'true');
                    modal.removeAttribute('aria-modal');
                    modal.removeAttribute('role');
                    document.body.style.overflow = '';
                });
            }
            
            // Fermer le modal en cliquant sur le backdrop
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modal.setAttribute('aria-hidden', 'true');
                    modal.removeAttribute('aria-modal');
                    modal.removeAttribute('role');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    {% endif %}

    // Auto-open main project modal if there are errors
    {% if show_main_modal %}
    document.addEventListener('DOMContentLoaded', function() {
        // Ouvrir automatiquement le modal principal avec le backdrop
        const modal = document.getElementById('defaultModal');
        if (modal) {
            // Supprimer la classe hidden et ajouter les classes pour afficher le modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.setAttribute('aria-hidden', 'false');
            modal.setAttribute('aria-modal', 'true');
            modal.setAttribute('role', 'dialog');
            
            // Ajouter les styles pour le backdrop
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '50';
            
            // Empêcher le scroll du body
            document.body.style.overflow = 'hidden';
            
            // Gérer la fermeture du modal
            const closeButton = modal.querySelector('[data-modal-hide="defaultModal"]');
            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modal.setAttribute('aria-hidden', 'true');
                    modal.removeAttribute('aria-modal');
                    modal.removeAttribute('role');
                    document.body.style.overflow = '';
                });
            }
            
            // Fermer le modal en cliquant sur le backdrop
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modal.setAttribute('aria-hidden', 'true');
                    modal.removeAttribute('aria-modal');
                    modal.removeAttribute('role');
                    document.body.style.overflow = '';
                }
            });
        }
    });
    {% endif %}

    // Login prompt modal functions
    function showLoginPrompt() {
        const modal = document.getElementById('loginPromptModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modal.setAttribute('aria-hidden', 'false');
            modal.setAttribute('aria-modal', 'true');
            modal.setAttribute('role', 'dialog');
            
            // Add backdrop styles
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            modal.style.zIndex = '50';
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            
            // Close modal when clicking backdrop
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeLoginPrompt();
                }
            });
        }
    }

    function closeLoginPrompt() {
        const modal = document.getElementById('loginPromptModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modal.setAttribute('aria-hidden', 'true');
            modal.removeAttribute('aria-modal');
            modal.removeAttribute('role');
            document.body.style.overflow = '';
        }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeLoginPrompt();
        }
    });
</script>
{% endblock %}