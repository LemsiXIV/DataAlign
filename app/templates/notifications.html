{% extends 'base.html' %}

{% block title %}Notifications - DataAlign{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Notifications</h1>
        <p class="mt-2 text-gray-600">Your recent notifications and updates</p>
    </div>

    {% if notifications.items %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <!-- Mark all as read button -->
            <div class="mb-4 flex justify-end">
                <button onclick="markAllAsRead()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    Mark All as Read
                </button>
            </div>
            
            <div class="space-y-4">
                {% for notification in notifications.items %}
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors
                           {% if not notification.is_read %}bg-blue-50 border-blue-200{% endif %}"
                     data-notification-id="{{ notification.id }}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <h3 class="text-lg font-medium text-gray-900">
                                    {{ notification.title }}
                                </h3>
                                {% if not notification.is_read %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    New
                                </span>
                                {% endif %}
                                <!-- Type badge -->
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if notification.type == 'success' %}bg-green-100 text-green-800
                                    {% elif notification.type == 'warning' %}bg-yellow-100 text-yellow-800
                                    {% elif notification.type == 'error' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if notification.type == 'success' %}✓
                                    {% elif notification.type == 'warning' %}⚠
                                    {% elif notification.type == 'error' %}✗
                                    {% else %}ℹ{% endif %}
                                    {{ notification.type.title() }}
                                </span>
                            </div>
                            <p class="mt-2 text-sm text-gray-600">
                                {{ notification.message }}
                            </p>
                            <p class="mt-2 text-xs text-gray-400">
                                <span class="notification-time" data-time="{{ notification.created_at.isoformat() }}Z">
                                    {{ notification.created_at.strftime('%d/%m/%Y at %H:%M') }}
                                </span>
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            {% if not notification.is_read %}
                            <button onclick="markAsRead({{ notification.id }})" 
                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                Mark as Read
                            </button>
                            {% endif %}
                            {% if notification.related_request_id and current_user.is_admin() %}
                            <a href="{{ url_for('admin.pending_requests') }}" 
                               class="text-green-600 hover:text-green-800 text-sm font-medium">
                                View Request
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if notifications.pages > 1 %}
            <div class="mt-6 flex items-center justify-between">
                <div class="flex-1 flex justify-between sm:hidden">
                    {% if notifications.has_prev %}
                    <a href="{{ url_for('notifications.notifications_page', page=notifications.prev_num) }}" 
                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Previous
                    </a>
                    {% endif %}
                    {% if notifications.has_next %}
                    <a href="{{ url_for('notifications.notifications_page', page=notifications.next_num) }}" 
                       class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Next
                    </a>
                    {% endif %}
                </div>
                
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            Showing
                            <span class="font-medium">{{ (notifications.page - 1) * notifications.per_page + 1 }}</span>
                            to
                            <span class="font-medium">{{ notifications.page * notifications.per_page if notifications.page * notifications.per_page < notifications.total else notifications.total }}</span>
                            of
                            <span class="font-medium">{{ notifications.total }}</span>
                            results
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            {% if notifications.has_prev %}
                            <a href="{{ url_for('notifications.notifications_page', page=notifications.prev_num) }}" 
                               class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                Previous
                            </a>
                            {% endif %}
                            
                            {% for page_num in notifications.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != notifications.page %}
                                <a href="{{ url_for('notifications.notifications_page', page=page_num) }}" 
                                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    {{ page_num }}
                                </a>
                                {% else %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                                    {{ page_num }}
                                </span>
                                {% endif %}
                            {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                ...
                            </span>
                            {% endif %}
                            {% endfor %}
                            
                            {% if notifications.has_next %}
                            <a href="{{ url_for('notifications.notifications_page', page=notifications.next_num) }}" 
                               class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                Next
                            </a>
                            {% endif %}
                        </nav>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM9 17H4l5 5v-5zM15 7h5l-5-5v5zM9 7H4l5-5v5z"></path>
                </svg>
            </div>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No notifications</h3>
            <p class="mt-1 text-sm text-gray-500">
                You don't have any notifications yet. When you make deletion requests or receive updates, they'll appear here.
            </p>
        </div>
    </div>
    {% endif %}
</div>

<script>
function markAsRead(notificationId) {
    fetch(`/api/notifications/${notificationId}/mark-read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the notification visually
            const notificationEl = document.querySelector(`[data-notification-id="${notificationId}"]`);
            notificationEl.classList.remove('bg-blue-50', 'border-blue-200');
            notificationEl.classList.add('bg-white');
            
            // Remove the "New" badge and mark as read button
            const newBadge = notificationEl.querySelector('.bg-blue-100');
            const markReadBtn = notificationEl.querySelector('button');
            if (newBadge) newBadge.remove();
            if (markReadBtn) markReadBtn.remove();
            
            // Update navbar notification count
            updateNotificationCount();
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
    });
}

function markAllAsRead() {
    fetch('/api/notifications/mark-all-read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated state
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error marking all notifications as read:', error);
    });
}

function updateNotificationCount() {
    fetch('/api/notifications/count')
    .then(response => response.json())
    .then(data => {
        const countEl = document.getElementById('notification-count');
        if (countEl) {
            if (data.unread_count > 0) {
                countEl.textContent = data.unread_count;
                countEl.classList.remove('hidden');
            } else {
                countEl.classList.add('hidden');
            }
        }
    });
}

function formatNotificationDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
    
    if (diffInSeconds < 0) {
        return 'Just now';
    } else if (diffInSeconds < 60) {
        return 'Just now';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else {
        const days = Math.floor(diffInSeconds / 86400);
        if (days === 1) {
            return 'Yesterday';
        } else if (days < 7) {
            return `${days} days ago`;
        } else {
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined 
            });
        }
    }
}

// Update notification times on page load
document.addEventListener('DOMContentLoaded', function() {
    const timeElements = document.querySelectorAll('.notification-time');
    timeElements.forEach(element => {
        const timeString = element.getAttribute('data-time');
        if (timeString) {
            element.textContent = formatNotificationDate(timeString);
        }
    });
});
</script>
{% endblock %}
