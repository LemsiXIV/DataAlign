{% extends 'base.html' %}

{% block title %}Notifications - DataAlign{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Notifications</h1>
        <p class="mt-2 text-gray-600">Your recent notifications and updates</p>
    </div>

    {% if notifications.items %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <!-- Action buttons -->
            <div class="mb-4 flex justify-between">
                <button onclick="deleteAllReadNotifications()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center space-x-2">
                    <span>üóëÔ∏è</span>
                    <span>Clear Read</span>
                </button>
                <button onclick="markAllAsRead()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    Mark All as Read
                </button>
            </div>
            
            <div class="space-y-4">
                {% for notification in notifications.items %}
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors
                           {% if not notification.is_read %}bg-blue-50 border-blue-200{% endif %}"
                     data-notification-id="{{ notification.id }}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <h3 class="text-lg font-medium text-gray-900">
                                    {{ notification.title }}
                                </h3>
                                {% if not notification.is_read %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    New
                                </span>
                                {% endif %}
                                <!-- Type badge -->
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if notification.type == 'success' %}bg-green-100 text-green-800
                                    {% elif notification.type == 'warning' %}bg-yellow-100 text-yellow-800
                                    {% elif notification.type == 'error' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {% if notification.type == 'success' %}‚úì
                                    {% elif notification.type == 'warning' %}‚ö†
                                    {% elif notification.type == 'error' %}‚úó
                                    {% else %}‚Ñπ{% endif %}
                                    {{ notification.type.title() }}
                                </span>
                            </div>
                            <p class="mt-2 text-sm text-gray-600">
                                {{ notification.message }}
                            </p>
                            <p class="mt-2 text-xs text-gray-400">
                                <span class="notification-time" data-time="{{ notification.created_at.isoformat() }}Z">
                                    {{ notification.created_at.strftime('%d/%m/%Y at %H:%M') }}
                                </span>
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            {% if not notification.is_read %}
                            <button onclick="markAsRead({{ notification.id }})" 
                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                Mark as Read
                            </button>
                            {% endif %}
                            <button onclick="deleteNotification({{ notification.id }}, event)" 
                                    class="text-red-600 hover:text-red-800 text-sm font-medium flex items-center space-x-1"
                                    title="Delete notification">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                                <span>Delete</span>
                            </button>
                            {% if notification.related_request_id and current_user.is_admin() %}
                            <a href="{{ url_for('admin.pending_requests') }}" 
                               class="text-green-600 hover:text-green-800 text-sm font-medium">
                                View Request
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if notifications.pages > 1 %}
            <div class="mt-6 flex items-center justify-between">
                <div class="flex-1 flex justify-between sm:hidden">
                    {% if notifications.has_prev %}
                    <a href="{{ url_for('notifications.notifications_page', page=notifications.prev_num) }}" 
                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Previous
                    </a>
                    {% endif %}
                    {% if notifications.has_next %}
                    <a href="{{ url_for('notifications.notifications_page', page=notifications.next_num) }}" 
                       class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Next
                    </a>
                    {% endif %}
                </div>
                
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700">
                            Showing
                            <span class="font-medium">{{ (notifications.page - 1) * notifications.per_page + 1 }}</span>
                            to
                            <span class="font-medium">{{ notifications.page * notifications.per_page if notifications.page * notifications.per_page < notifications.total else notifications.total }}</span>
                            of
                            <span class="font-medium">{{ notifications.total }}</span>
                            results
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            {% if notifications.has_prev %}
                            <a href="{{ url_for('notifications.notifications_page', page=notifications.prev_num) }}" 
                               class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                Previous
                            </a>
                            {% endif %}
                            
                            {% for page_num in notifications.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != notifications.page %}
                                <a href="{{ url_for('notifications.notifications_page', page=page_num) }}" 
                                   class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    {{ page_num }}
                                </a>
                                {% else %}
                                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                                    {{ page_num }}
                                </span>
                                {% endif %}
                            {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                ...
                            </span>
                            {% endif %}
                            {% endfor %}
                            
                            {% if notifications.has_next %}
                            <a href="{{ url_for('notifications.notifications_page', page=notifications.next_num) }}" 
                               class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                Next
                            </a>
                            {% endif %}
                        </nav>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM9 17H4l5 5v-5zM15 7h5l-5-5v5zM9 7H4l5-5v5z"></path>
                </svg>
            </div>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No notifications</h3>
            <p class="mt-1 text-sm text-gray-500">
                You don't have any notifications yet. When you make deletion requests or receive updates, they'll appear here.
            </p>
        </div>
    </div>
    {% endif %}
</div>

<!-- Custom Confirmation Modals -->
<!-- Delete Single Notification Modal -->
<div id="deleteNotificationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 text-center mb-4">Delete Notification</h3>
            <p class="text-center text-sm text-gray-600 mb-6">
                Are you sure you want to delete this notification? This action cannot be undone.
            </p>
            
            <div class="flex space-x-3">
                <button type="button" 
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded text-sm font-medium"
                        onclick="closeDeleteModal()">
                    Cancel
                </button>
                <button type="button" 
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium"
                        onclick="confirmDeleteNotification()">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete All Read Notifications Modal -->
<div id="deleteAllReadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 text-center mb-4">Delete All Read Notifications</h3>
            <p class="text-center text-sm text-gray-600 mb-6">
                Are you sure you want to delete all read notifications? This action cannot be undone and will permanently remove all notifications you have already read.
            </p>
            
            <div class="flex space-x-3">
                <button type="button" 
                        class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded text-sm font-medium"
                        onclick="closeDeleteAllReadModal()">
                    Cancel
                </button>
                <button type="button" 
                        class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm font-medium"
                        onclick="confirmDeleteAllRead()">
                    Delete All Read
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success/Info Modal -->
<div id="successModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 text-center mb-4" id="successModalTitle">Success</h3>
            <p class="text-center text-sm text-gray-600 mb-6" id="successModalMessage">
                Operation completed successfully.
            </p>
            
            <div class="flex justify-center">
                <button type="button" 
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded text-sm font-medium"
                        onclick="closeSuccessModal()">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function markAsRead(notificationId) {
    fetch(`/api/notifications/${notificationId}/mark-read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the notification visually
            const notificationEl = document.querySelector(`[data-notification-id="${notificationId}"]`);
            notificationEl.classList.remove('bg-blue-50', 'border-blue-200');
            notificationEl.classList.add('bg-white');
            
            // Remove the "New" badge and mark as read button
            const newBadge = notificationEl.querySelector('.bg-blue-100');
            const markReadBtn = notificationEl.querySelector('button');
            if (newBadge) newBadge.remove();
            if (markReadBtn) markReadBtn.remove();
            
            // Update navbar notification count
            updateNotificationCount();
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
    });
}

function markAllAsRead() {
    fetch('/api/notifications/mark-all-read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated state
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error marking all notifications as read:', error);
    });
}

function deleteNotification(notificationId, event) {
    // Prevent any default behavior
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // Store the notification ID for confirmation
    window.currentDeleteNotificationId = notificationId;
    
    // Show custom modal instead of browser confirm
    document.getElementById('deleteNotificationModal').classList.remove('hidden');
}

function confirmDeleteNotification() {
    const notificationId = window.currentDeleteNotificationId;
    
    fetch(`/api/notifications/${notificationId}/delete`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close the confirmation modal
            closeDeleteModal();
            
            // Remove the notification from the UI immediately
            const notificationEl = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationEl) {
                notificationEl.style.transition = 'opacity 0.3s ease-out';
                notificationEl.style.opacity = '0';
                setTimeout(() => {
                    notificationEl.remove();
                    
                    // Check if there are no more notifications and reload if needed
                    const remainingNotifications = document.querySelectorAll('[data-notification-id]');
                    if (remainingNotifications.length === 0) {
                        location.reload();
                    }
                }, 300);
            }
            
            // Update navbar notification count
            updateNotificationCount();
            
            // Show success message
            showSuccessModal('Notification Deleted', 'The notification has been successfully deleted.');
        }
    })
    .catch(error => {
        console.error('Error deleting notification:', error);
        closeDeleteModal();
        showSuccessModal('Error', 'Error deleting notification. Please try again.', 'error');
    });
}

function closeDeleteModal() {
    document.getElementById('deleteNotificationModal').classList.add('hidden');
    window.currentDeleteNotificationId = null;
}

function deleteAllReadNotifications() {
    // Show custom modal instead of browser confirm
    document.getElementById('deleteAllReadModal').classList.remove('hidden');
}

function confirmDeleteAllRead() {
    fetch('/api/notifications/delete-read', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeDeleteAllReadModal();
            
            if (data.deleted_count > 0) {
                showSuccessModal('Notifications Deleted', `${data.deleted_count} read notifications have been deleted.`);
                // Reload the page after showing success message
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showSuccessModal('No Notifications Found', 'No read notifications were found to delete.', 'info');
            }
        }
    })
    .catch(error => {
        console.error('Error deleting read notifications:', error);
        closeDeleteAllReadModal();
        showSuccessModal('Error', 'Error deleting read notifications. Please try again.', 'error');
    });
}

function closeDeleteAllReadModal() {
    document.getElementById('deleteAllReadModal').classList.add('hidden');
}

function showSuccessModal(title, message, type = 'success') {
    const modal = document.getElementById('successModal');
    const titleEl = document.getElementById('successModalTitle');
    const messageEl = document.getElementById('successModalMessage');
    const iconContainer = modal.querySelector('.mx-auto');
    
    titleEl.textContent = title;
    messageEl.textContent = message;
    
    // Update icon and colors based on type
    if (type === 'error') {
        iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4';
        iconContainer.innerHTML = `
            <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        `;
    } else if (type === 'info') {
        iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4';
        iconContainer.innerHTML = `
            <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        `;
    } else {
        iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4';
        iconContainer.innerHTML = `
            <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        `;
    }
    
    modal.classList.remove('hidden');
}

function closeSuccessModal() {
    document.getElementById('successModal').classList.add('hidden');
}

function updateNotificationCount() {
    fetch('/api/notifications/count')
    .then(response => response.json())
    .then(data => {
        const countEl = document.getElementById('notification-count');
        if (countEl) {
            if (data.unread_count > 0) {
                countEl.textContent = data.unread_count;
                countEl.classList.remove('hidden');
            } else {
                countEl.classList.add('hidden');
            }
        }
    });
}

function formatNotificationDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
    
    if (diffInSeconds < 0) {
        return 'Just now';
    } else if (diffInSeconds < 60) {
        return 'Just now';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else {
        const days = Math.floor(diffInSeconds / 86400);
        if (days === 1) {
            return 'Yesterday';
        } else if (days < 7) {
            return `${days} days ago`;
        } else {
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined 
            });
        }
    }
}

// Update notification times on page load
document.addEventListener('DOMContentLoaded', function() {
    const timeElements = document.querySelectorAll('.notification-time');
    timeElements.forEach(element => {
        const timeString = element.getAttribute('data-time');
        if (timeString) {
            element.textContent = formatNotificationDate(timeString);
        }
    });
    
    // Add event listeners for modal functionality
    
    // Close modals when clicking outside
    document.getElementById('deleteNotificationModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
    
    document.getElementById('deleteAllReadModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteAllReadModal();
        }
    });
    
    document.getElementById('successModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeSuccessModal();
        }
    });
    
    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeDeleteModal();
            closeDeleteAllReadModal();
            closeSuccessModal();
        }
    });
});
</script>
{% endblock %}
